<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Oficios Destacados</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/destacados.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@11.1.1/dist/css/shepherd.css">
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@11.1.1/dist/js/shepherd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body id="body">
    <!-- Overlay para móviles -->
    <div class="overlay" id="overlay"></div>
    
    <!-- Botón para abrir/cerrar el menú (solo visible en móviles) -->
    <button id="btn_open" class="btn">
        <i class="bi bi-list"></i>
    </button>
    
  <!-- Sidebar -->
<div id="menu_side" class="menu__side sidebar d-flex flex-column">
    <img src="img/logo.webp" alt="Logo" style="width:120px; margin:0 auto 20px auto; display:block;">
    <a href="inicio.html" class="btn btn-menu mb-2"><i class="bi bi-house me-2"></i> Inicio</a>
    <a href="subiroficios.html" class="btn btn-menu mb-2"><i class="bi bi-upload me-2"></i> Subir oficios</a>
    <a href="destacados.html" class="btn btn-menu mb-2 btn-active"><i class="bi bi-star me-2"></i> Destacados</a>
    <a href="borradores.html" class="btn btn-menu mb-2"><i class="bi bi-file-earmark me-2"></i> Borradores</a>
    <a href="calendario.html" class="btn btn-menu mb-2"><i class="bi bi-calendar me-2"></i> Calendario</a>
   <a href="#" id="logoutBtn" class="btn btn-menu mt-auto logout-btn">
    <i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión
</a>
</div>
  
    <div class="content">
        <!-- Contenedor blanco con el título principal -->
        <div class="white-container mb-4">
            <h1 id="main-title">
                <i class="bi bi-star" style="color: #691B31;"></i> Oficios Destacados
            </h1>
            <p class="text-muted">Visualiza los oficios marcados como destacados</p>
            
            <!-- Filtros y búsqueda -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="searchInput" class="form-control" placeholder="Buscar destacado...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select id="filtroPrioridad" class="form-select">
                        <option value="">Todas las prioridades</option>
                        <option value="alta">Alta</option>
                        <option value="media">Media</option>
                        <option value="baja">Baja</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button id="btnLimpiarFiltros" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-arrow-clockwise me-2"></i>Limpiar filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabla de oficios -->
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-hover mt-3 mb-0">
                    <thead>
                        <tr>
                            <th>No. de Oficio</th>
                            <th>Fecha de Entrega</th>
                            <th>Destinatario</th>
                            <th>Prioridad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-oficios">
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2 mb-0">Cargando oficios destacados...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para ver oficio -->
    <div class="modal fade" id="modalOficio" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-vino text-white">
                    <h5 class="modal-title"><i class="bi bi-file-text me-2"></i>Detalles del Oficio</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-body-oficio"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
document.addEventListener("DOMContentLoaded", async () => {
    const tabla = document.getElementById("tabla-oficios");
    const modalBody = document.getElementById("modal-body-oficio");
    const modal = new bootstrap.Modal(document.getElementById('modalOficio'));
    const btnOpen = document.getElementById('btn_open');
    const menuSide = document.getElementById('menu_side');
    const overlay = document.getElementById('overlay');
    const searchInput = document.getElementById("searchInput");
    const priorityFilter = document.getElementById("filtroPrioridad");
    const btnLimpiarFiltros = document.getElementById("btnLimpiarFiltros");
    const logoutBtn = document.getElementById("logoutBtn"); // Nuevo: botón de logout
    
    let oficiosData = []; // Para almacenar todos los oficios

    // ----- FUNCIÓN DE LOGOUT -----
    /**
     * Función reutilizable para cerrar sesión con confirmación y manejo de errores
     */
    async function logout(redirectUrl = 'index.html', confirmMessage = '¿Estás seguro de que deseas cerrar sesión?') {
        try {
            const result = await Swal.fire({
                title: 'Cerrar sesión',
                text: confirmMessage,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6f7271',
                confirmButtonText: 'Sí, cerrar sesión',
                cancelButtonText: 'Cancelar'
            });

            if (!result.isConfirmed) {
                return false;
            }

            Swal.fire({
                title: 'Cerrando sesión...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // 1. Intentar cerrar sesión en el backend
            try {
                const response = await fetch('/auth/logout', { 
                    method: 'POST', 
                    credentials: 'include' 
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Logout backend exitoso:', data);
                }
            } catch (backendError) {
                console.warn('No se pudo contactar al servidor para cerrar sesión:', backendError);
                // Continuamos con la limpieza local aunque falle el backend
            }

            // 2. Limpiar almacenamiento local
            clearUserData();

            // 3. Redirigir al usuario
            setTimeout(() => {
                Swal.close();
                window.location.href = redirectUrl;
            }, 1000);
            
            return true;

        } catch (error) {
            console.error('Error durante el logout:', error);
            
            // Mostrar error al usuario pero proceder con el logout del frontend
            Swal.fire({
                icon: 'warning',
                title: 'Aviso',
                text: 'Error al contactar el servidor, pero se limpiaron los datos locales.',
                confirmButtonText: 'Aceptar'
            }).then(() => {
                clearUserData();
                window.location.href = redirectUrl;
            });
            
            return false;
        }
    }

    /**
     * Limpia todos los datos de usuario del almacenamiento local
     */
    function clearUserData() {
        // Limpiar localStorage
        const itemsToRemove = [
            'userToken', 'userData', 'session', 'authToken', 
            'userProfile', 'userPreferences', 'loginTime',
            'tutorialDestacadosVisto', 'tutorialSubirVisto', 'tutorialVisto'
        ];
        
        itemsToRemove.forEach(item => {
            localStorage.removeItem(item);
        });
        
        // Limpiar sessionStorage
        sessionStorage.clear();
        
        // Limpiar cookies
        clearCookies();
    }

    /**
     * Limpia las cookies relacionadas con la autenticación
     */
    function clearCookies() {
        const cookies = document.cookie.split(";");
        
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i];
            const eqPos = cookie.indexOf("=");
            const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
            
            // Eliminar cookies de autenticación
            if (name.includes('auth') || name.includes('session') || name.includes('token')) {
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
            }
        }
    }

    // Función para forzar logout (sin confirmación)
    async function forceLogout() {
        Swal.fire({
            title: 'Sesión expirada',
            text: 'Su sesión ha expirado. Será redirigido al login.',
            icon: 'warning',
            confirmButtonText: 'Aceptar',
            allowOutsideClick: false
        }).then(() => {
            clearUserData();
            window.location.href = 'index.html';
        });
    }

    // ----- EVENT LISTENER PARA LOGOUT -----
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            logout();
        });
    } else {
        console.warn('Botón de logout no encontrado. Asegúrate de tener un elemento con id="logoutBtn"');
    }

    // ----- TUTORIAL CON SHEPHERD.JS -----
    function inicializarTutorial() {
        const tour = new Shepherd.Tour({
            defaultStepOptions: {
                cancelIcon: { enabled: true },
                classes: 'shadow-lg bg-white rounded p-3',
                scrollTo: { behavior: 'smooth', block: 'center' },
            },
            useModalOverlay: true,
        });

        tour.addStep({
            id: 'step-1',
            text: 'Bienvenido a Oficios Destacados ⭐ Aquí encontrarás todos los oficios que has marcado como importantes.',
            attachTo: { 
                element: '#main-title', 
                on: 'bottom' 
            },
            buttons: [
                { 
                    text: 'Siguiente', 
                    action: tour.next 
                }
            ]
        });

        tour.addStep({
            id: 'step-2',
            text: 'Usa la barra de búsqueda para encontrar oficios específicos por número, destinatario o asunto.',
            attachTo: { 
                element: '#searchInput', 
                on: 'bottom' 
            },
            buttons: [
                { 
                    text: 'Atrás', 
                    action: tour.back 
                },
                { 
                    text: 'Siguiente', 
                    action: tour.next 
                }
            ]
        });

        tour.addStep({
            id: 'step-3',
            text: 'Filtra los oficios destacados por prioridad para organizar mejor tu trabajo.',
            attachTo: { 
                element: '#filtroPrioridad', 
                on: 'bottom' 
            },
            buttons: [
                { 
                    text: 'Atrás', 
                    action: tour.back 
                },
                { 
                    text: 'Siguiente', 
                    action: tour.next 
                }
            ]
        });

        tour.addStep({
            id: 'step-4',
            text: 'Limpia todos los filtros con este botón para ver todos tus oficios destacados nuevamente.',
            attachTo: { 
                element: '#btnLimpiarFiltros', 
                on: 'bottom' 
            },
            buttons: [
                { 
                    text: 'Atrás', 
                    action: tour.back 
                },
                { 
                    text: 'Siguiente', 
                    action: tour.next 
                }
            ]
        });

        tour.addStep({
            id: 'step-5',
            text: 'En esta tabla verás todos tus oficios destacados. Puedes ver detalles, descargar archivos o quitar el destacado.',
            attachTo: { 
                element: '.table-responsive', 
                on: 'top' 
            },
            buttons: [
                { 
                    text: 'Atrás', 
                    action: tour.back 
                },
                { 
                    text: 'Siguiente', 
                    action: tour.next 
                }
            ]
        });

        tour.addStep({
            id: 'step-6',
            text: 'Desde el menú lateral puedes navegar a otras secciones del sistema o cerrar sesión.',
            attachTo: { 
                element: '#menu_side', 
                on: 'right' 
            },
            buttons: [
                { 
                    text: 'Atrás', 
                    action: tour.back 
                },
                { 
                    text: 'Finalizar', 
                    action: tour.complete 
                }
            ]
        });

        return tour;
    }

    // ----- BOTÓN PARA INICIAR TUTORIAL -----
    function agregarBotonTutorial() {
        // Crear botón flotante para el tutorial
        const botonTutorial = document.createElement('button');
        botonTutorial.innerHTML = '<i class="bi bi-question-circle"></i>';
        botonTutorial.className = 'btn btn-primary position-fixed';
        botonTutorial.style.cssText = `
            right: 20px;
            bottom: 20px;
            z-index: 1100;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
        `;
        botonTutorial.title = 'Iniciar tutorial';

        botonTutorial.addEventListener('click', function() {
            const tour = inicializarTutorial();
            tour.start();
        });

        document.body.appendChild(botonTutorial);
    }

    // ----- INICIAR TUTORIAL AUTOMÁTICAMENTE (OPCIONAL) -----
    function iniciarTutorialAutomatico() {
        // Solo iniciar automáticamente si es la primera vez en esta página
        const tutorialDestacadosVisto = localStorage.getItem('tutorialDestacadosVisto');
        
        if (!tutorialDestacadosVisto) {
            setTimeout(() => {
                const tour = inicializarTutorial();
                tour.start();
                localStorage.setItem('tutorialDestacadosVisto', 'true');
            }, 1500); // Pequeño delay para que cargue todo
        }
    }

    // Funcionalidad del sidebar para móviles
    function toggleSidebar() {
        if (window.innerWidth <= 992) {
            document.body.classList.toggle("body_move");
            menuSide.classList.toggle("menu__side_move");
            overlay.classList.toggle("active");
        }
    }

    if (btnOpen && menuSide && overlay) {
        btnOpen.addEventListener("click", toggleSidebar);
        overlay.addEventListener("click", toggleSidebar);
    }

    // Cerrar sidebar al hacer clic en un enlace (en móviles)
    document.querySelectorAll(".btn-menu").forEach(link => {
        link.addEventListener("click", function() {
            if (window.innerWidth <= 992) {
                toggleSidebar();
            }
        });
    });
    
    // Función para formatear fechas
    function formatearFecha(fecha) {
        if (!fecha) return '-';
        try {
            const fechaObj = new Date(fecha);
            return fechaObj.toLocaleDateString('es-ES');
        } catch {
            return fecha;
        }
    }
    
    // Función para actualizar estado destacado
    async function updateDestacado(id, estado) {
        try {
            const response = await fetch(`http://localhost:3002/oficios/${id}/destacar`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ destacado: estado ? 1 : 0 })
            });
            
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error("Error al actualizar el estado destacado:", error);
            throw error;
        }
    }
    
    // Función para filtrar oficios
    function filtrarOficios() {
        const searchTerm = searchInput.value.toLowerCase();
        const priorityValue = priorityFilter.value;
        
        const oficiosFiltrados = oficiosData.filter(oficio => {
            const matchesSearch = 
                !searchTerm || 
                (oficio.numeroOficio && oficio.numeroOficio.toLowerCase().includes(searchTerm)) ||
                (oficio.destinatario && oficio.destinatario.toLowerCase().includes(searchTerm)) ||
                (oficio.asunto && oficio.asunto.toLowerCase().includes(searchTerm));
            
            const matchesPriority = !priorityValue || oficio.prioridad === priorityValue;
            
            return matchesSearch && matchesPriority;
        });
        
        mostrarOficios(oficiosFiltrados);
    }
    
    // Función para limpiar filtros
    function limpiarFiltros() {
        if (searchInput) searchInput.value = '';
        if (priorityFilter) priorityFilter.value = '';
        filtrarOficios();
    }
    
    // Función para mostrar oficios en la tabla
    function mostrarOficios(oficios) {
        if (!tabla) return;
        
        tabla.innerHTML = "";
        
        if (!oficios.length) {
            tabla.innerHTML = `
                <tr>
                    <td colspan="5" class="empty-state py-5">
                        <i class="bi bi-star"></i>
                        <h4 class="mt-3">No hay oficios destacados</h4>
                        <p>Marca algunos oficios como destacados para verlos aquí.</p>
                    </td>
                </tr>`;
            return;
        }
        
        oficios.forEach((oficio, index) => {
            const row = document.createElement("tr");
            row.style.animationDelay = `${index * 0.05}s`;
            row.classList.add("fade-in");
            
            row.innerHTML = `
                <td>${oficio.numeroOficio || '-'}</td>
                <td>${formatearFecha(oficio.fechaEntrega)}</td>
                <td>${oficio.destinatario || '-'}</td>
                <td>
                    <span class="${oficio.prioridad === 'Alta' ? 'status-high' : oficio.prioridad === 'Media' ? 'status-medium' : 'status-low'}">
                        ${oficio.prioridad || '-'}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary btn-action btn-view" data-id="${oficio.id}" title="Ver detalles">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success btn-action btn-download" data-id="${oficio.id}" title="Descargar">
                            <i class="bi bi-download"></i>
                        </button>
                        <button class="btn-star active" data-id="${oficio.id}" title="Quitar de destacados">
                            <i class="bi bi-star-fill"></i>
                        </button>
                    </div>
                </td>
            `;
            tabla.appendChild(row);
            
            // Ver detalles en modal
            row.querySelector(".btn-view").addEventListener("click", () => {
                if (!modalBody) return;
                
                modalBody.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>No. de Oficio:</strong> ${oficio.numeroOficio || '-'}</p>
                            <p><strong>Asunto:</strong> ${oficio.asunto || '-'}</p>
                            <p><strong>Fecha de Creación:</strong> ${formatearFecha(oficio.fechaCreacion)}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Fecha de Entrega:</strong> ${formatearFecha(oficio.fechaEntrega)}</p>
                            <p><strong>Destinatario:</strong> ${oficio.destinatario || '-'}</p>
                            <p><strong>Prioridad:</strong> ${oficio.prioridad || '-'}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <p><strong>Observaciones:</strong> ${oficio.observaciones || 'No hay observaciones'}</p>
                        </div>
                    </div>
                    ${oficio.archivos && JSON.parse(oficio.archivos).length ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <p><strong>Archivos adjuntos:</strong></p>
                            <ul>
                                ${JSON.parse(oficio.archivos).map(archivo => 
                                    `<li><a href="http://localhost:3002/uploads/${archivo}" target="_blank">${archivo}</a></li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>` : ''}
                `;
                if (modal) modal.show();
            });
            
            // Descargar PDF
            row.querySelector(".btn-download").addEventListener("click", () => {
                try {
                    const archivos = oficio.archivos ? JSON.parse(oficio.archivos) : [];
                    if (archivos.length) {
                        const url = `http://localhost:3002/uploads/${archivos[0]}`;
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = archivos[0];
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        // Mostrar notificación de éxito
                        mostrarNotificacion(`Descargando: ${archivos[0]}`, "success");
                    } else {
                        mostrarNotificacion("No hay archivos para descargar", "warning");
                    }
                } catch (error) {
                    console.error("Error al descargar archivo:", error);
                    mostrarNotificacion("Error al intentar descargar el archivo", "error");
                }
            });
            
            // Toggle destacado
            const btnStar = row.querySelector(".btn-star");
            btnStar.addEventListener("click", async () => {
                try {
                    const nuevoEstado = false; // Siempre será false porque estamos quitando de destacados
                    
                    // Animación de eliminación
                    row.style.opacity = "0.5";
                    row.style.transition = "opacity 0.3s ease";
                    
                    await updateDestacado(oficio.id, nuevoEstado);
                    
                    setTimeout(() => {
                        row.remove();
                        // Actualizar datos
                        oficiosData = oficiosData.filter(o => o.id !== oficio.id);
                        // Si no quedan oficios, mostrar estado vacío
                        if (tabla.children.length === 0) {
                            mostrarOficios([]);
                        }
                    }, 300);
                    
                    mostrarNotificacion("Oficio quitado de destacados", "success");
                    
                } catch (error) {
                    console.error("Error al cambiar estado destacado:", error);
                    row.style.opacity = "1"; // Revertir animación en caso de error
                    mostrarNotificacion("Error al actualizar el estado del oficio", "error");
                }
            });
        });
    }
    
    // Función para mostrar notificaciones
    function mostrarNotificacion(mensaje, tipo) {
        // Crear elemento de notificación
        const notificacion = document.createElement("div");
        notificacion.className = `alert alert-${tipo === 'error' ? 'danger' : tipo === 'warning' ? 'warning' : 'success'} alert-dismissible fade show`;
        notificacion.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        
        notificacion.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notificacion);
        
        // Auto-eliminar después de 4 segundos
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.parentNode.removeChild(notificacion);
            }
        }, 4000);
    }
    
    // Función para cargar y mostrar oficios
    async function cargarOficios() {
        try {
            const resp = await fetch("http://localhost:3002/oficios/destacados");
            
            if (!resp.ok) {
                throw new Error(`Error HTTP: ${resp.status}`);
            }
            
            oficiosData = await resp.json();
            mostrarOficios(oficiosData);
            
        } catch (err) {
            console.error("Error al cargar oficios:", err);
            if (tabla) {
                tabla.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger py-4">
                            <i class="bi bi-exclamation-triangle display-4 d-block mb-2"></i>
                            <h4>Error al cargar los oficios</h4>
                            <p>Por favor, intenta nuevamente más tarde.</p>
                            <button class="btn btn-primary mt-2" onclick="location.reload()">Reintentar</button>
                        </td>
                    </tr>`;
            }
        }
    }
    
    // Event listeners para filtros
    if (searchInput) {
        searchInput.addEventListener('input', filtrarOficios);
    }
    
    if (priorityFilter) {
        priorityFilter.addEventListener('change', filtrarOficios);
    }
    
    if (btnLimpiarFiltros) {
        btnLimpiarFiltros.addEventListener('click', limpiarFiltros);
    }
    
    // Ajustar el sidebar al cambiar el tamaño de la ventana
    window.addEventListener("resize", function () {
        if (window.innerWidth > 992) {
            document.body.classList.remove("body_move");
            if (menuSide) menuSide.classList.remove("menu__side_move");
            if (overlay) overlay.classList.remove("active");
        }
    });
    
    // Inicializar tutorial y cargar oficios
    agregarBotonTutorial();
    await cargarOficios();
    
    // Opcional: iniciar tutorial automáticamente en primera visita
    // iniciarTutorialAutomatico();
});
</script>
</body>
</html>