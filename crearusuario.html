<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Crear Usuario</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/crearusuario.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body id="body">

  <!-- Botón para abrir/cerrar el menú -->
  <button id="btn_open" class="btn btn-secondary">
    <span class="bi bi-list"></span>
  </button>

  <!-- Menu lateral -->
  <div id="menu_side" class="menu__side sidebar d-flex flex-column">
    <img src="img/logo.webp" alt="Logo" style="width:120px; margin:0 auto 20px auto; display:block;">
    <a href="inicio.html" class="btn btn-menu mb-2"><i class="bi bi-house me-2"></i> Inicio</a>
    <a href="subiroficios.html" class="btn btn-menu mb-2"><i class="bi bi-upload me-2"></i> Subir oficios</a>
    <a href="destacados.html" class="btn btn-menu mb-2"><i class="bi bi-star me-2"></i> Destacados</a>
    <a href="borradores.html" class="btn btn-menu mb-2"><i class="bi bi-file-earmark me-2"></i> Borradores</a>
    <a href="calendario.html" class="btn btn-menu mb-2"><i class="bi bi-calendar me-2"></i> Calendario</a>
    <a href="#" id="logoutBtn" class="btn btn-menu mt-auto logout-btn">
    <i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión
</a>
    </div>
  <div class="container d-flex align-items-center justify-content-center min-vh-100 flex-column flex-lg-row">
    <div class="white-container order-1 order-lg-2">

      <h1 class="page-title">Crear Usuario</h1>
      <p class="mb-4" style="color:#343a40;">
        Completa el formulario para registrarte en el Sistema de Seguimiento de Oficios de Radio y Televisión de Hidalgo
      </p>
      
      <form>
        <!-- Nombre -->
        <label class="form-label">Nombre</label>
        <input type="text" class="form-control mb-3" placeholder="Nombre" required>

        <!-- Apellidos -->
        <label class="form-label">Apellidos</label>
        <input type="text" class="form-control mb-3" placeholder="Apellidos" required>

        <!-- Correo -->
        <label class="form-label">Correo electrónico</label>
        <input type="email" class="form-control mb-3" placeholder="Correo electrónico" required>

        <!-- Contraseña -->
        <label class="form-label">Contraseña</label>
        <input type="password" class="form-control mb-3" placeholder="Contraseña" required>

        <!-- Confirmar contraseña -->
        <label class="form-label">Confirmar contraseña</label>
        <input type="password" class="form-control mb-3" placeholder="Confirmar Contraseña" required>

        <!-- Cargo -->
        <label class="form-label">Cargo</label>
        <select class="form-control mb-3" required>
          <option value="">Selecciona un cargo</option>
          <option value="1">Dirección</option>
          <option value="2">Subdirección</option>
          <option value="3">Jefe de departamento</option>  
          <option value="4">Encargado de departamento</option>
        </select>

        <!-- Área -->
        <label class="form-label">Área</label>
        <select class="form-control mb-3" required>
          <option value="">Selecciona un área</option>
          <option value="1">Dirección general</option>
          <option value="2">Dirección de coordinación financiera y planeación</option>
          <option value="3">Dirección de televisión</option>     
          <option value="4">Dirección de noticias</option>
          <option value="5">Dirección de radio</option>
          <option value="6">Dirección de ingeniería</option>
          <option value="7">Dirección de proyectos estratégicos</option>
          <option value="8">Dirección de contaduría</option>
          <option value="9">Dirección de promoción e intercambio</option>
          <option value="10">Dirección jurídica</option>
          <option value="11">Imagen</option>
          <option value="12">Estaciones de radio</option>
        </select>

        <!-- Puesto -->
        <label class="form-label">Puesto</label>
        <select class="form-control mb-3" required>
          <option value="">Selecciona un puesto</option>
          <option value="1">Dirección General</option>
          <option value="2">Asistente de la Dirección General</option>
          <option value="3">Dto. Evaluación y Seguimiento</option>
          <option value="4">Auxiliar del Departamento de la Dirección General</option>
          <option value="5">Recepción Entrada Principal</option>
          <option value="6">Dirección de Coordinación Financiera y Planeación</option>
          <option value="7">Subdirector de Administración</option>
          <option value="8">Recursos Humanos</option>
          <option value="9">Servicios Generales</option>
          <option value="10">Archivo</option>
          <option value="11">Tecnologías de la Información</option>
          <option value="12">Dirección de Televisión</option>
          <option value="13">Subdirector de Contenidos</option>
          <option value="14">Encargada de Planeación Postproducción TV</option>
          <option value="15">Encargado de Videoteca</option>
          <option value="16">Encargado de Deportes</option>
          <option value="17">Isla Edición de Televisión</option>
          <option value="18">Cabina de Video</option>
          <option value="19">Oficialidad de Partes</option>
        </select>

        <!-- Foto -->
        <label class="form-label">Foto</label>
        <input type="file" class="form-control mb-3" accept="image/*">

        <!-- Botón -->
        <button type="submit" class="btn btn-primary w-100">Registrar</button>
      </form>
    </div>
  </div>
 <script>
document.addEventListener("DOMContentLoaded", function () {
    const btnOpen = document.getElementById("btn_open");
    const sideMenu = document.getElementById("menu_side");
    const body = document.getElementById("body");
    const form = document.querySelector('form');
    const passwordInput = document.querySelector('input[type="password"]');
    const confirmPasswordInput = document.querySelectorAll('input[type="password"]')[1];
    const fileInput = document.querySelector('input[type="file"]');
    const submitBtn = form.querySelector('button[type="submit"]');
    const logoutBtn = document.getElementById("logoutBtn"); // Nuevo: botón de logout
    const originalText = submitBtn.innerHTML; 

    // ----- FUNCIÓN DE LOGOUT -----
    /**
     * Función reutilizable para cerrar sesión con confirmación y manejo de errores
     */
    async function logout(redirectUrl = 'index.html', confirmMessage = '¿Estás seguro de que deseas cerrar sesión?') {
        // Verificar que SweetAlert2 esté disponible
        if (typeof Swal === 'undefined') {
            console.error('SweetAlert2 no está cargado');
            if (confirm(confirmMessage)) {
                clearUserData();
                window.location.href = redirectUrl;
            }
            return;
        }

        try {
            const result = await Swal.fire({
                title: 'Cerrar sesión',
                text: confirmMessage,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6f7271',
                confirmButtonText: 'Sí, cerrar sesión',
                cancelButtonText: 'Cancelar'
            });

            if (!result.isConfirmed) {
                return false;
            }

            // Mostrar loading
            Swal.fire({
                title: 'Cerrando sesión...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Limpiar datos locales inmediatamente
            clearUserData();

            // Intentar logout en el backend (pero no bloquear si falla)
            fetch('/auth/logout', { 
                method: 'POST', 
                credentials: 'include' 
            })
            .then(response => {
                console.log('Logout backend exitoso');
            })
            .catch(error => {
                console.warn('Error en logout backend:', error);
            })
            .finally(() => {
                // Redirigir después de 1 segundo
                setTimeout(() => {
                    Swal.close();
                    window.location.href = redirectUrl;
                }, 1000);
            });

            return true;

        } catch (error) {
            console.error('Error durante el logout:', error);
            
            // Fallback: limpiar y redirigir
            clearUserData();
            window.location.href = redirectUrl;
            return false;
        }
    }

    /**
     * Limpia todos los datos de usuario del almacenamiento local
     */
    function clearUserData() {
        console.log('Limpiando datos de usuario...');
        
        // Limpiar localStorage
        localStorage.clear();
        
        // Limpiar sessionStorage
        sessionStorage.clear();
        
        // Limpiar cookies específicas
        clearCookies();
    }

    /**
     * Limpia las cookies relacionadas con la autenticación
     */
    function clearCookies() {
        const cookies = document.cookie.split(";");
        const domain = window.location.hostname;
        
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i];
            const eqPos = cookie.indexOf("=");
            const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
            
            // Eliminar cookies de autenticación
            if (name.includes('auth') || name.includes('session') || name.includes('token')) {
                document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=${domain}`;
                document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
            }
        }
    }

    // ----- EVENT LISTENER PARA LOGOUT -----
    if (logoutBtn) {
        console.log('Botón de logout encontrado, agregando event listener...');
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Clic en botón de logout');
            logout();
        });
    } else {
        console.error('Botón de logout no encontrado. Buscando elemento con id="logoutBtn"');
    }

    // Abrir/cerrar menú lateral
    btnOpen.addEventListener("click", () => {
        body.classList.toggle("body_move");
        sideMenu.classList.toggle("menu__side_move");
    });

    // Ajustar al redimensionar
    window.addEventListener("resize", () => {
        if (window.innerWidth > 768) {
            body.classList.remove("body_move");
            sideMenu.classList.remove("menu__side_move");
        }
    });

    // Crear elementos dinámicos
    createDynamicElements();

    // Validación en tiempo real
    setupRealTimeValidation();

    // Manejo del formulario
    form.addEventListener("submit", handleFormSubmit);

    // ----------------------- Funciones -----------------------
    function createDynamicElements() {
        createPasswordStrengthIndicator();
        createTogglePasswordButtons();
        createImagePreview();
    }

    function createPasswordStrengthIndicator() {
        const strengthIndicator = document.createElement('div');
        strengthIndicator.className = 'password-strength';
        passwordInput.parentElement.appendChild(strengthIndicator);
    }

    function createTogglePasswordButtons() {
        [passwordInput, confirmPasswordInput].forEach(input => {
            const toggleBtn = document.createElement('button');
            toggleBtn.type = 'button';
            toggleBtn.className = 'toggle-password';
            toggleBtn.innerHTML = '<i class="bi bi-eye"></i>';

            const group = document.createElement('div');
            group.className = 'password-group';
            input.parentNode.insertBefore(group, input);
            group.appendChild(input);
            group.appendChild(toggleBtn);

            toggleBtn.addEventListener('click', () => {
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);
                toggleBtn.innerHTML = type === 'password' ? '<i class="bi bi-eye"></i>' : '<i class="bi bi-eye-slash"></i>';
            });
        });
    }

    function createImagePreview() {
        const preview = document.createElement('img');
        preview.className = 'image-preview';
        fileInput.parentElement.insertBefore(preview, fileInput);

        fileInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });
    }

    function setupRealTimeValidation() {
        // Password
        passwordInput.addEventListener('input', () => {
            validatePasswordStrength(passwordInput.value);
            validatePasswordMatch();
        });
        confirmPasswordInput.addEventListener('input', validatePasswordMatch);

        // Email
        const emailInput = document.querySelector('input[type="email"]');
        emailInput.addEventListener('blur', () => validateEmail(emailInput));

        // Campos requeridos
        const requiredInputs = form.querySelectorAll('input[required], select[required]');
        requiredInputs.forEach(input => input.addEventListener('blur', () => validateRequiredField(input)));
    }

    function validatePasswordStrength(password) {
        const strengthIndicator = document.querySelector('.password-strength');
        let strength = 0;
        if (password.length >= 8) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;

        strengthIndicator.className = 'password-strength ';
        if (password.length === 0) {
            strengthIndicator.style.width = '0%';
        } else if (strength === 1) {
            strengthIndicator.classList.add('strength-weak');
        } else if (strength === 2) {
            strengthIndicator.classList.add('strength-fair');
        } else if (strength === 3) {
            strengthIndicator.classList.add('strength-good');
        } else if (strength === 4) {
            strengthIndicator.classList.add('strength-strong');
        }
    }

    function validatePasswordMatch() {
        if (confirmPasswordInput.value && passwordInput.value !== confirmPasswordInput.value) {
            confirmPasswordInput.classList.add('is-invalid');
            showFeedback(confirmPasswordInput, 'Las contraseñas no coinciden');
        } else {
            confirmPasswordInput.classList.remove('is-invalid');
            hideFeedback(confirmPasswordInput);
        }
    }

    function validateEmail(input) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(input.value)) {
            input.classList.add('is-invalid');
            showFeedback(input, 'Por favor ingresa un email válido');
        } else {
            input.classList.remove('is-invalid');
            hideFeedback(input);
        }
    }

    function validateRequiredField(input) {
        if (!input.value.trim()) {
            input.classList.add('is-invalid');
            showFeedback(input, 'Este campo es requerido');
        } else {
            input.classList.remove('is-invalid');
            hideFeedback(input);
        }
    }

    function showFeedback(input, message) {
        let feedback = input.nextElementSibling;
        if (!feedback || !feedback.classList.contains('invalid-feedback')) {
            feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            input.parentNode.insertBefore(feedback, input.nextSibling);
        }
        feedback.textContent = message;
    }

    function hideFeedback(input) {
        const feedback = input.nextElementSibling;
        if (feedback && feedback.classList.contains('invalid-feedback')) feedback.remove();
    }

    async function handleFormSubmit(e) {
        e.preventDefault();

        // Validación completa
        let isValid = true;
        const requiredInputs = form.querySelectorAll('input[required], select[required]');
        requiredInputs.forEach(input => {
            if (!input.value.trim()) {
                input.classList.add('is-invalid');
                showFeedback(input, 'Este campo es requerido');
                isValid = false;
            }
        });
        if (passwordInput.value !== confirmPasswordInput.value) {
            confirmPasswordInput.classList.add('is-invalid');
            showFeedback(confirmPasswordInput, 'Las contraseñas no coinciden');
            isValid = false;
        }
        if (!isValid) {
            showNotification('Por favor corrige los errores en el formulario', 'error');
            return;
        }

        // FormData
        const formData = new FormData();
        formData.append('nombre', document.querySelector('input[placeholder="Nombre"]').value);
        formData.append('apellidos', document.querySelector('input[placeholder="Apellidos"]').value);
        formData.append('email', document.querySelector('input[type="email"]').value);
        formData.append('password', passwordInput.value);
        formData.append('cargo', document.querySelectorAll('select')[0].value);
        formData.append('area', document.querySelectorAll('select')[1].value);
        formData.append('puesto', document.querySelectorAll('select')[2].value);
        if (fileInput.files[0]) formData.append('foto', fileInput.files[0]);

        try {
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Creando usuario...';
            submitBtn.disabled = true;

            const response = await fetch('/api/usuarios', { method: 'POST', body: formData });
            if (response.ok) {
                const result = await response.json();
                showNotification('Usuario creado exitosamente', 'success');
                form.reset();
                document.querySelector('.image-preview').style.display = 'none';
            } else {
                throw new Error('Error en la respuesta del servidor');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error al crear el usuario. Por favor intenta nuevamente.', 'error');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    function showNotification(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
        alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);

        setTimeout(() => {
            if (alert.parentNode) alert.parentNode.removeChild(alert);
        }, 5000);
    }
});
</script>
</body>
</html>
